<p-dialog 
  [(visible)]="open" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="true"
  [maximizable]="true"
  [baseZIndex]="10000"
  [style]="{width: isSingleColumn ? '50vw' : '80vw'}"
  (onHide)="closeSidebar()"
  class="custom-dialog"
>
  <ng-template pTemplate="header">
    <div class="flex items-center justify-between w-full">
      <h2 class="text-xl font-bold text-gray-800">{{ fromTitle }}</h2>
      <button 
        class="p-1 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-100 transition-colors"
        (click)="closeSidebar()"
        aria-label="Close dialog"
      >
        <i class="pi pi-times text-lg"></i>
      </button>
    </div>
  </ng-template>

  <!-- Form Content -->
  <div class="p-6 bg-blue-50">
    <form [formGroup]="form" class="space-y-6" (ngSubmit)="handleSubmit($event)">
      
      <!-- Two Column Layout -->
      <div class="grid gap-6 mb-6" [ngClass]="isSingleColumn ? 'grid-cols-1' : 'md:grid-cols-2 grid-cols-1'">
        
        <!-- Left Column -->
        <div class="space-y-4">
          <div *ngFor="let field of getLeftColumnFields(); let i = index" class="grid grid-cols-1 gap-2">
            <!-- Label -->
            <label [for]="field.key" class="text-sm font-medium text-gray-700 flex items-center">
              {{ field.label }} 
              <span *ngIf="field.required" class="text-red-500 ml-1">*</span>
            </label>

            <!-- Input Container -->
            <div class="space-y-1">
              
              <!-- Text/Number/Email inputs -->
              <input
                *ngIf="
                  field.type !== 'checkbox' &&
                  field.type !== 'select' &&
                  field.type !== 'select-multiple' &&
                  field.type !== 'file' &&
                  field.type !== 'textarea' &&
                  field.type !== 'text' &&
                  field.type !== 'address' &&
                  field.type !== 'date'
                "
                [id]="field.key"
                [type]="field.type"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
                [placeholder]="field.placeholder"
              />

              <!-- Date input -->
              <input
                *ngIf="field.type === 'date'"
                [id]="field.key"
                type="date"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
                [placeholder]="field.placeholder"
              />

              <!-- Checkbox -->
              <div *ngIf="field.type === 'checkbox'" class="flex items-center">
                <input
                  [id]="field.key"
                  type="checkbox"
                  [formControlName]="field.key"
                  class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                />
                <label [for]="field.key" class="ml-2 text-sm text-gray-700 cursor-pointer">
                  {{ field.placeholder || 'Check this option' }}
                </label>
              </div>

              <!-- Select dropdown -->
              <select
                *ngIf="field.type === 'select'"
                [id]="field.key"
                [formControlName]="field.key"
                (change)="handleSelectChange($event, field.key)"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
              >
                <option value="" disabled selected>Select an option</option>
                <option
                  *ngFor="let option of getOptionsForField(field.key)"
                  [value]="option.value"
                >
                  {{ option.label }}
                </option>
              </select>

              <!-- File upload -->
              <div
                *ngIf="field.type === 'file'"
                class="w-full p-4 border-2 border-dashed border-gray-300 rounded-lg bg-white hover:border-blue-400 transition-colors cursor-pointer text-center"
                (click)="triggerFileInputClick(fileInputRef)"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onFileDrop($event, field.key)"
                [class.border-blue-400]="isDragging"
                [class.bg-blue-50]="isDragging"
              >
                <input
                  #fileInputRef
                  [id]="field.key"
                  type="file"
                  (change)="handleFileInput($event, field.key)"
                  class="hidden"
                />
                <div class="flex flex-col items-center gap-2">
                  <i class="pi pi-cloud-upload text-3xl text-gray-400"></i>
                  <div>
                    <p class="text-sm font-medium text-gray-700">Drag & drop file here</p>
                    <p class="text-xs text-gray-500">or click to browse</p>
                  </div>
                  <div *ngIf="form.get(field.key)?.value" class="text-sm text-green-600 font-medium mt-2">
                    <i class="pi pi-check-circle mr-1"></i>
                    {{ getFileName(form.get(field.key)?.value) }}
                  </div>
                  <div *ngIf="!form.get(field.key)?.value && isEditMode && mediaFiles.length === 0 && documentFiles.length === 0" class="text-sm text-gray-500 italic">
                    No file selected
                  </div>
                </div>
              </div>

              <!-- Textarea -->
              <textarea
                *ngIf="field.type === 'textarea' || field.type === 'address'"
                [id]="field.key"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-vertical"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
                [rows]="field.type === 'address' ? 3 : 4"
                [placeholder]="field.placeholder"
              ></textarea>

              <!-- Text -->
              <input
                *ngIf="field.type === 'text'"
                [id]="field.key"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                [placeholder]="field.placeholder"
              />

              <!-- Error message -->
              <div *ngIf="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)" 
                   class="flex items-center gap-2 text-red-500 text-xs mt-1">
                <i class="pi pi-exclamation-circle"></i>
                <span *ngIf="form.get(field.key)?.errors?.['required']">{{ field.label }} is required.</span>
                <span *ngIf="form.get(field.key)?.errors?.['email']">Please enter a valid email.</span>
                <span *ngIf="form.get(field.key)?.errors?.['minlength']">Minimum length is {{ form.get(field.key)?.errors?.['minlength']?.requiredLength }} characters.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-4">
          <div *ngFor="let field of getRightColumnFields(); let i = index" class="grid grid-cols-1 gap-2">
            
            <!-- Label -->
            <label [for]="field.key" class="text-sm font-medium text-gray-700 flex items-center">
              {{ field.label }} 
              <span *ngIf="field.required" class="text-red-500 ml-1">*</span>
            </label>

            <!-- Input Container -->
            <div class="space-y-1">
              
              <!-- Text/Number/Email inputs -->
              <input
                *ngIf="
                  field.type !== 'checkbox' &&
                  field.type !== 'select' &&
                  field.type !== 'select-multiple' &&
                  field.type !== 'file' &&
                  field.type !== 'textarea' &&
                  field.type !== 'text' &&
                  field.type !== 'address' &&
                  field.type !== 'date'
                "
                [id]="field.key"
                [type]="field.type"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
                [placeholder]="field.placeholder"
              />

              <!-- Date input -->
              <input
                *ngIf="field.type === 'date'"
                [id]="field.key"
                type="date"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
                [placeholder]="field.placeholder"
              />

              <!-- Checkbox -->
              <div *ngIf="field.type === 'checkbox'" class="flex items-center">
                <input
                  [id]="field.key"
                  type="checkbox"
                  [formControlName]="field.key"
                  class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                />
                <label [for]="field.key" class="ml-2 text-sm text-gray-700 cursor-pointer">
                  {{ field.placeholder || 'Check this option' }}
                </label>
              </div>

              <!-- Select dropdown -->
              <select
                *ngIf="field.type === 'select'"
                [id]="field.key"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
              >
                <option value="" disabled selected>Select an option</option>
                <option
                  *ngFor="let option of getOptionsForField(field.key)"
                  [value]="option.value"
                >
                  {{ option.label }}
                </option>
              </select>
              
              <!-- MultiSelect dropdown -->
              <p-multiSelect
                *ngIf="field.type === 'select-multiple'"
                [id]="field.key"
                [formControlName]="field.key"
                [options]="getOptionsForField(field.key)"
                optionLabel="label"
                optionValue="value"
                class="w-full border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
                defaultLabel="Select options"
                display="chip"
              ></p-multiSelect>

              <!-- File upload -->
              <div
                *ngIf="field.type === 'file'"
                class="w-full p-4 border-2 border-dashed border-gray-300 rounded-lg bg-white hover:border-blue-400 transition-colors cursor-pointer text-center"
                (click)="triggerFileInputClick(fileInputRef)"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onFileDrop($event, field.key)"
                [class.border-blue-400]="isDragging"
                [class.bg-blue-50]="isDragging"
              >
                <input
                  #fileInputRef
                  [id]="field.key"
                  type="file"
                  (change)="handleFileInput($event, field.key)"
                  class="hidden"
                />
                <div class="flex flex-col items-center gap-2">
                  <i class="pi pi-cloud-upload text-3xl text-gray-400"></i>
                  <div>
                    <p class="text-sm font-medium text-gray-700">Drag & drop file here</p>
                    <p class="text-xs text-gray-500">or click to browse</p>
                  </div>
                  <div *ngIf="form.get(field.key)?.value" class="text-sm text-green-600 font-medium mt-2">
                    <i class="pi pi-check-circle mr-1"></i>
                    {{ getFileName(form.get(field.key)?.value) }}
                  </div>
                  <div *ngIf="!form.get(field.key)?.value && isEditMode && mediaFiles.length === 0 && documentFiles.length === 0" class="text-sm text-gray-500 italic">
                    No file selected
                  </div>
                </div>
              </div>

              <!-- Textarea -->
              <textarea
                *ngIf="field.type === 'textarea' || field.type === 'address'"
                [id]="field.key"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-vertical"
                [class.border-red-500]="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)"
                [rows]="field.type === 'address' ? 3 : 4"
                [placeholder]="field.placeholder"
              ></textarea>

              <!-- Text -->
              <input
                *ngIf="field.type === 'text'"
                [id]="field.key"
                [formControlName]="field.key"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                [placeholder]="field.placeholder"
              />

              <!-- Error message -->
              <div *ngIf="form.get(field.key)?.invalid && (form.get(field.key)?.dirty || form.get(field.key)?.touched)" 
                   class="flex items-center gap-2 text-red-500 text-xs mt-1">
                <i class="pi pi-exclamation-circle"></i>
                <span *ngIf="form.get(field.key)?.errors?.['required']">{{ field.label }} is required.</span>
                <span *ngIf="form.get(field.key)?.errors?.['email']">Please enter a valid email.</span>
                <span *ngIf="form.get(field.key)?.errors?.['minlength']">Minimum length is {{ form.get(field.key)?.errors?.['minlength']?.requiredLength }} characters.</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit button -->
      <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
        <button 
          type="button" 
          class="px-5 py-2.5 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200 font-medium"
          (click)="closeSidebar()">
          Cancel
        </button>
        <button 
          type="submit" 
          class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 font-medium disabled:bg-blue-400 disabled:cursor-not-allowed"
          [disabled]="!form.valid">
          {{ submitLabel || 'Save' }}
        </button>
      </div>
    </form>

    <!-- Attached Files Section -->
    <div
      *ngIf="mediaFiles.length > 0 || documentFiles.length > 0"
      class="mt-8 p-5 bg-white rounded-lg border border-gray-200 shadow-sm"
    >
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="pi pi-paperclip text-blue-500"></i>
        Attached Files
      </h3>
      
      <!-- Media Files -->
      <div *ngIf="mediaFiles.length > 0" class="mb-6">
        <h4 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-3 flex items-center gap-2">
          <i class="pi pi-image"></i>
          Media Files
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div
            *ngFor="let media of mediaFiles; let i = index"
            class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition-all"
          >
            <a
              [href]="media.file"
              download
              target="_blank"
              class="flex items-center gap-3 text-blue-600 hover:text-blue-800 font-medium truncate"
            >
              <i class="pi pi-file text-lg"></i>
              <span class="text-sm truncate">{{ getFileName(media.file) }}</span>
            </a>
            <button
              (click)="deleteFile(media.id!)"
              class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-md transition-colors"
              aria-label="Delete file"
            >
              <i class="pi pi-trash"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Document Files -->
      <div *ngIf="documentFiles.length > 0" class="mb-4" [class.mt-6]="mediaFiles.length > 0">
        <h4 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-3 flex items-center gap-2">
          <i class="pi pi-file-pdf"></i>
          Document Files
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div
            *ngFor="let document of documentFiles; let i = index"
            class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition-all"
          >
            <a
              [href]="document.file"
              download
              target="_blank"
              class="flex items-center gap-3 text-blue-600 hover:text-blue-800 font-medium truncate"
            >
              <i class="pi pi-file-pdf text-lg"></i>
              <span class="text-sm truncate">{{ getFileName(document.file) }}</span>
            </a>
            <button
              (click)="deleteDocumentFile(document.id!)"
              class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-md transition-colors"
              aria-label="Delete document file"
            >
              <i class="pi pi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</p-dialog>