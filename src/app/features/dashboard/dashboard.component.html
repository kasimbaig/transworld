

<div class="naval-dashboard p-4 overflow-x-hidden">
  <!-- Dashboard Tabs - Positioned above the header -->

  <div class="command-header">
    <div class="command-title-block">
      <i class="fa-solid fa-user-circle"></i>
      <div>
        <h2>Naval Fleet Maintenance Dashboard</h2>
        <p>Comprehensive fleet maintenance overview and analytics</p>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-container w-full max-w-full" *ngIf="activeTab === 'dashboard'">
    <!-- KPI Cards Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8 w-full max-w-full">
      <div 
        class="group relative rounded-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-2 transition-all duration-300 ease-in-out overflow-hidden border border-gray-100 hover:border-blue-200" 
        *ngFor="let metric of kpiMetrics"
        [style.background]="metric.backgroundColor ? 'linear-gradient(135deg, ' + metric.backgroundColor + ', ' + metric.backgroundColor + '90)' : 'linear-gradient(135deg, #ffffff, #f8fafc)'"
      >
     
        <div class="absolute inset-0 opacity-5 group-hover:opacity-10 transition-opacity duration-300">
          <div class="absolute -top-4 -right-4 w-24 h-24 rounded-full bg-gradient-to-br from-blue-400 to-purple-500"></div>
          <div class="absolute -bottom-4 -left-4 w-16 h-16 rounded-full bg-gradient-to-tr from-green-400 to-blue-500"></div>
        </div>
        
        <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-400/0 via-purple-400/0 to-pink-400/0 group-hover:from-blue-400/10 group-hover:via-purple-400/10 group-hover:to-pink-400/10 transition-all duration-500"></div>
        
        <div class="relative p-6 h-full flex flex-col">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="p-2 rounded-lg bg-gradient-to-br from-blue-50 to-indigo-100 group-hover:from-blue-100 group-hover:to-indigo-200 transition-all duration-300">
                <i 
                  class="pi text-xl group-hover:scale-110 transition-transform duration-300" 
                  [ngClass]="metric.iconClass" 
                  [style.color]="metric.iconColor || '#4f46e5'"
                ></i>
              </div>
              <span class="text-sm font-semibold text-gray-600 group-hover:text-gray-800 transition-colors duration-300">{{ metric.title }}</span>
            </div>
           
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse group-hover:bg-blue-400 transition-colors duration-300"></div>
          </div>

         
          <div class="flex-1 flex items-center justify-center mb-4">
            <h2 
              class="text-3xl font-bold text-center group-hover:scale-105 transition-transform duration-300" 
              [style.color]="metric.valueColor || '#1f2937'"
            >
              {{ metric.value }}
            </h2>
          </div>

         
          <div class="mt-auto">
            <ng-container [ngSwitch]="metric.type">
             
              <ng-container *ngSwitchCase="'TOTAL_EQUIPMENT'">
                <div class="flex items-center justify-center space-x-2 p-2 rounded-lg bg-gray-50 group-hover:bg-gradient-to-r group-hover:from-blue-50 group-hover:to-indigo-50 transition-all duration-300">
                  <div 
                    class="flex items-center space-x-1 px-2 py-1 rounded-full text-xs font-medium transition-all duration-300"
                    [ngClass]="{
                      'bg-green-100 text-green-700 group-hover:bg-green-200': metric.trendDirection === 'up',
                      'bg-red-100 text-red-700 group-hover:bg-red-200': metric.trendDirection === 'down',
                      'bg-gray-100 text-gray-700 group-hover:bg-gray-200': metric.trendDirection === 'neutral'
                    }"
                  >
                    <i 
                      class="pi text-xs group-hover:animate-bounce" 
                      [ngClass]="{
                        'pi-arrow-up': metric.trendDirection === 'up',
                        'pi-arrow-down': metric.trendDirection === 'down',
                        'pi-minus': metric.trendDirection === 'neutral'
                      }"
                    ></i>
                    <span>{{ metric.trendPercentage }}</span>
                  </div>
                </div>
              </ng-container>

             
              <ng-container *ngSwitchCase="'ACTIVE_MAINTENANCE_TASKS'">
                <div class="space-y-2">
                  <div class="w-full bg-gray-200 rounded-full h-2 group-hover:h-3 transition-all duration-300 overflow-hidden">
                    <div 
                      class="bg-gradient-to-r from-blue-500 to-purple-600 h-full rounded-full transition-all duration-500 group-hover:from-blue-400 group-hover:to-purple-500 relative"
                      [style.width.%]="metric.progressBarValue"
                    >
                      <div class="absolute inset-0 bg-white/20 animate-pulse rounded-full"></div>
                    </div>
                  </div>
                  <p class="text-xs text-gray-500 text-center group-hover:text-gray-700 transition-colors duration-300">{{ metric.progressBarValue }}% Complete</p>
                </div>
              </ng-container>

             
              <ng-container *ngSwitchCase="'OPEN_DEFECTS'">
                <div class="flex flex-wrap justify-center gap-2">
                  <span 
                    *ngIf="metric.severityDetails?.critical" 
                    class="px-2 py-1 text-xs font-medium bg-red-100 text-red-700 rounded-full group-hover:bg-red-200 group-hover:shadow-md transition-all duration-300"
                  >
                    {{ metric.severityDetails?.critical }} Critical
                  </span>
                  <span 
                    *ngIf="metric.severityDetails?.major" 
                    class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-700 rounded-full group-hover:bg-orange-200 group-hover:shadow-md transition-all duration-300"
                  >
                    {{ metric.severityDetails?.major }} Major
                  </span>
                  <span 
                    *ngIf="metric.severityDetails?.minor" 
                    class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full group-hover:bg-yellow-200 group-hover:shadow-md transition-all duration-300"
                  >
                    {{ metric.severityDetails?.minor }} Minor
                  </span>
                </div>
              </ng-container>

             
              <ng-container *ngSwitchCase="'EQUIPMENT_FIT_PROGRESS'">
                <div class="text-center p-2 rounded-lg bg-gradient-to-r from-green-50 to-emerald-50 group-hover:from-green-100 group-hover:to-emerald-100 transition-all duration-300">
                  <p class="text-sm text-green-700 font-medium group-hover:text-green-800 transition-colors duration-300">{{ metric.subText }}</p>
                </div>
              </ng-container>

             
              <ng-container *ngSwitchCase="'TASK_COMPLETION_RATE'">
                <div class="text-center p-2 rounded-lg bg-gradient-to-r from-blue-50 to-cyan-50 group-hover:from-blue-100 group-hover:to-cyan-100 transition-all duration-300">
                  <p class="text-sm text-blue-700 font-medium group-hover:text-blue-800 transition-colors duration-300">{{ metric.subText }}</p>
                </div>
              </ng-container>

             
              <ng-container *ngSwitchCase="'OPERATIONAL_SHIPS'">
                <div class="text-center p-2 rounded-lg bg-gradient-to-r from-purple-50 to-pink-50 group-hover:from-purple-100 group-hover:to-pink-100 transition-all duration-300">
                  <p class="text-sm text-purple-700 font-medium group-hover:text-purple-800 transition-colors duration-300">{{ metric.description }}</p>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </div>

       
        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
      </div>
    </div>

    <!-- Filters -->
    <!-- <div class="dashboard-header w-full max-w-full"> -->
      <!-- <div class="filter-group">
        <p-dropdown [options]="(commands$ | async) ?? []" [(ngModel)]="selectedCommand" placeholder="Command"
          optionLabel="label" optionValue="value" (onChange)="onCommandChange()" [showClear]="true"
          styleClass="filter-dropdown"></p-dropdown>

        <p-dropdown [options]="filteredShips" [(ngModel)]="selectedShip" placeholder="Ship" optionLabel="label"
          optionValue="value" [disabled]="!selectedCommand" (onChange)="onShipChange()" [showClear]="true"
          styleClass="filter-dropdown"></p-dropdown>

        <p-dropdown [options]="(departments$ | async) ?? []" [(ngModel)]="selectedDept" placeholder="Department"
          optionLabel="label" optionValue="value" [disabled]="!selectedShip" (onChange)="onDeptChange()"
          [showClear]="true" styleClass="filter-dropdown"></p-dropdown> -->

        <!-- <p-calendar [(ngModel)]="dateRange" selectionMode="range" placeholder="Select Date Range" [showIcon]="true"
          dateFormat="dd/mm/yy" [readonlyInput]="true"></p-calendar> -->

        <!-- <button pButton label="Apply" icon="pi pi-check" (click)="applyFilters()" class="p-ml-2 btn-app"></button>
        <button pButton label="Clear" icon="pi pi-times" (click)="clearFilters()" class="p-ml-2 btn-app"></button>
      </div>
    </div> -->

    <!-- <div class="w-full bg-white p-3 rounded-xl shadow-lg">
      <div class="w-full ">
        <app-ocrc [menuExpanded]="menuExpanded"></app-ocrc>
      </div>
      <div class="chart-container mt-3">
        <app-defect-list
      [command]="selectedCommand !== null ? selectedCommand.toString() : null"
      [ship]="selectedShip !== null ? selectedShip.toString() : null"
      [dept]="selectedDept !== null ? selectedDept.toString() : null"
    ></app-defect-list>
      </div>
    </div> -->

    <div class="charts-section w-full max-w-full mt-4">
      <div class="chart-container">
        <!-- Convert selectedCommand, selectedShip, selectedDept to string if not null -->
        <app-opdef [command]="selectedCommand !== null ? selectedCommand.toString() : null"
          [ship]="selectedShip !== null ? selectedShip.toString() : null"
          [dept]="selectedDept !== null ? selectedDept.toString() : null" [dateRange]="dateRange"></app-opdef>
      </div>
      <div class="chart-container">
        <app-frequent-defects [chartData]="frequentDefectData"></app-frequent-defects>
      </div>
    </div>
    <!-- Fleet Status Section -->
     <div class="bg-white p-4 rounded-xl shadow-lg w-full max-w-full">

       <div class="fleet-status-header-actions w-full max-w-full">
         <h2>Fleet Status</h2>
         <div class="action-buttons">
           <button pButton icon="pi pi-plus" label="Add Defect" class="btn-primary" (click)="addNewDefect()"></button>
           <button pButton icon="pi pi-book" label="Log Maintenance" class="btn-primary"
             (click)="logMaintenance()"></button>
           <button pButton icon="pi pi-eye" label="View Equipment Fit" class="btn-primary"
             (click)="viewEquipmentFit()"></button>
           <button *ngIf="isApprover" pButton icon="pi pi-check-circle" label="Approve Plan" class="btn-primary"
             (click)="showApprovePlanDialog = true"></button>
         </div>
       </div>
   
       <!-- Fleet Status Table -->
       <table border="1" class="w-full mb-5 border-collapse border border-gray-300 max-w-full">
         <thead>
           <tr class="border border-gray-300">
             <th class="border border-gray-300">Ship</th>
             <th class="border border-gray-300">Readiness</th>
             <th class="border border-gray-300">Open Defects</th>
             <th class="border border-gray-300">Next Maintenance</th>
             <th class="border border-gray-300">Status</th>
           </tr>
         </thead>
         <tbody>
           <tr *ngFor="let ship of fleetStatus" class="border border-gray-300">
             <td class="border border-gray-300">{{ ship.ship }}</td>
             <td class="border border-gray-300">
               <p-progressBar [value]="ship.readiness || 0" styleClass="custom-progress"
                 [showValue]="true"></p-progressBar>
             </td>
             <td class="border border-gray-300">{{ ship.defects }}</td>
             <td class="border border-gray-300">{{ ship.maintenance }}</td>
             <td class="border border-gray-300">
               <span class="status-badge" [ngClass]="getStatusClass(ship.readiness)">
                 <i class="pi"
                   [ngClass]="ship.readiness >=90 ? 'pi-check-circle' : (ship.readiness>=75 ? 'pi-exclamation-circle':'pi-times-circle')"></i>
                 {{ ship.readiness >=90 ? 'Operational' : (ship.readiness>=75 ? 'Limited' : 'In Maintenance') }}
               </span>
             </td>
           </tr>
           <tr *ngIf="!fleetStatus || fleetStatus.length === 0" class="border border-gray-300">
             <td colspan="5" class="p-text-center table-placeholder border border-gray-300">
               <i class="pi pi-database"></i>
               <p>No fleet status data available.</p>
             </td>
           </tr>
         </tbody>
       </table>
     </div>
  </div>
</div>



<!-- Dialogs -->

<!-- Add New Defect Dialog using Reusable Form -->
<app-add-form
  *ngIf="showDefectsFormDialog"
  [open]="showDefectsFormDialog"
  [formConfig]="defectsFormConfig"
  [formData]="newDefect"
  [fromTitle]="'Add New Defect'"
  [submitLabel]="'Submit Defect'"
  (onOpenChange)="showDefectsFormDialog = $event"
  (onSubmit)="handleDefectsFormSubmit($event)"
></app-add-form>

<!-- Log Maintenance Dialog -->
<p-dialog header="Log Maintenance Activity" [(visible)]="showLogMaintenanceDialog"
  [style]="{width: '650px', maxWidth: '90vw'}" styleClass="custom-dialog"
  [breakpoints]="{'960px': '75vw', '640px': '90vw'}" [contentStyle]="{'max-height': '80vh', 'overflow': 'auto'}">

  <div class="dialog-content p-fluid p-formgrid p-grid p-3 gap-3">
    <!-- Maintenance Type -->
    <div class="p-field p-col-12 p-md-6">
      <label for="maintenanceType" class="p-text-bold">Maintenance Type <span class="required-asterisk">*</span></label>
      <p-dropdown inputId="maintenanceType" [options]="maintenanceTypeOptions"
        [(ngModel)]="maintenanceLog.maintenanceType" placeholder="Select Type" optionLabel="label" optionValue="value"
        [required]="true" styleClass="drop"></p-dropdown>
    </div>

    <!-- Maintenance Frequency -->
    <div class="p-field p-col-12 p-md-6">
      <label for="maintenanceFrequency" class="p-text-bold">Frequency <span class="required-asterisk">*</span></label>
      <p-dropdown inputId="maintenanceFrequency" [options]="maintenanceFrequencyOptions"
        [(ngModel)]="maintenanceLog.frequency" placeholder="Select Frequency" optionLabel="label" optionValue="value"
        [required]="true" styleClass="drop"></p-dropdown>
    </div>

    <div class="p-field p-col-12 p-md-6">
      <label for="maintenanceTask" class="p-text-bold">Task Title <span class="required-asterisk">*</span></label>
      <input id="maintenanceTask" type="text" class="border-2 border-gray-500 rounded-sm bg-white" pInputText [(ngModel)]="maintenanceLog.task"
        placeholder="e.g., Daily engine inspection" style="width: 100%;" [required]="true" />
    </div>


    <!-- Equipment -->
    <div class="p-field p-col-12 p-md-6">
      <label for="maintenanceEquipment" class="p-text-bold">Equipment/System <span
          class="required-asterisk">*</span></label>
      <p-dropdown inputId="maintenanceEquipment" [options]="equipmentOptions" [(ngModel)]="maintenanceLog.equipment"
        placeholder="Select Equipment/System" optionLabel="label" optionValue="value" [required]="true"
        styleClass="drop"></p-dropdown>
    </div>

    <!-- Assigned Personnel -->
    <div class="p-field p-col-12 p-md-6">
      <label for="assignedPersonnel" class="p-text-bold">Assigned Personnel <span
          class="required-asterisk">*</span></label>
      <p-dropdown inputId="assignedPersonnel" [options]="personnelOptions"
        [(ngModel)]="maintenanceLog.assignedPersonnel" placeholder="Select Personnel" optionLabel="label"
        optionValue="value" [required]="true" styleClass="drop"></p-dropdown>
    </div>

    <!-- Hours Spent -->
    <div class="p-field p-col-12 p-md-6">
      <label for="maintenanceHours" class="p-text-bold">Hours Spent <span class="required-asterisk">*</span></label>
      <p-inputNumber id="maintenanceHours" class="p-inputtext" [(ngModel)]="maintenanceLog.hours" placeholder="e.g., 8"
        style="width: 100%;" mode="decimal" [required]="true"></p-inputNumber>
    </div>

    <!-- Date of Completion -->
    <div class="p-field p-col-12 p-md-6">
      <label for="completionDate" class="p-text-bold">Date of Completion <span
          class="required-asterisk">*</span></label>
      <p-calendar id="completionDate" [(ngModel)]="maintenanceLog.completionDate" [readonlyInput]="true"
        dateFormat="dd/mm/yy" [required]="true" styleClass="drop"></p-calendar>
    </div>

    <!-- Spares Used -->
    <div class="p-field p-col-12">
      <label for="sparesUsed" class="p-text-bold">Spares Used (Comma Separated)</label>
      <textarea id="sparesUsed" pInputTextarea rows="2" [(ngModel)]="maintenanceLog.sparesUsed"
        placeholder="e.g., Filter A, Gasket B"></textarea>
    </div>

    <!-- Remarks / Feedback -->
    <div class="p-field p-col-12">
      <label for="maintenanceRemarks" class="p-text-bold">Remarks / Feedback</label>
      <textarea id="maintenanceRemarks" pInputTextarea rows="3" [(ngModel)]="maintenanceLog.remarks"
        placeholder="Any additional notes or observations."></textarea>
    </div>
  </div>

  <!-- Footer -->
  <ng-template pTemplate="footer">
    <div class="footer-actions">
      <button pButton label="Cancel" icon="pi pi-times" class="p-button-secondary p-button-text"
        (click)="showLogMaintenanceDialog = false"></button>
      <button pButton label="Submit Log" icon="pi pi-check" class="p-button-primary"
        (click)="submitMaintenanceLog()"></button>
    </div>
  </ng-template>

</p-dialog>

<!-- Equipment Fit Dialog -->
<p-dialog header="View Equipment Fit" [(visible)]="showEquipmentFitDialog" [style]="{ width: '80vw' }"
  styleClass="custom-dialog" [modal]="true" [closable]="true">

  <div class="equipment-fit-view">
    <div class="p-fluid p-formgrid p-grid p-3 gap-3 mb-4">
      <div class="p-field p-col-12 p-md-6">
        <label for="efCommand" class="p-text-bold">Command</label>
        <p-dropdown inputId="efCommand" [options]="(commands$ | async) ?? []" [(ngModel)]="selectedEFCommand"
          placeholder="Select Command" optionLabel="label" optionValue="value" [showClear]="true"></p-dropdown>
      </div>
      <div class="p-field p-col-12 p-md-6">
        <label for="efShip" class="p-text-bold">Ship</label>
        <p-dropdown inputId="efShip" [options]="filteredShips" [(ngModel)]="selectedEFShip" placeholder="Select Ship"
          optionLabel="label" optionValue="value" [showClear]="true"></p-dropdown>
      </div>
    </div>

    <p-table [value]="equipmentList" styleClass="p-datatable-sm custom-table" [responsiveLayout]="'scroll'"
      scrollHeight="60vh">

      <ng-template pTemplate="header">
        <tr>
          <th style="min-width: 200px;">🔧 Equipment Name</th>
          <th style="min-width: 150px;">📦 NSN/Part No.</th>
          <th style="min-width: 120px;">🏢 Department</th>
          <th style="min-width: 120px;">🚢 Compartment</th>
          <th style="min-width: 150px;">📋 Status</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-equip>
        <tr>
          <td>{{ equip.name }}</td>
          <td>{{ equip.nsn || equip.partNumber || 'N/A' }}</td>
          <td>{{ equip.department || 'N/A' }}</td>
          <td>{{ equip.compartment || 'N/A' }}</td>
          <td>
            <span class="badge status-badge" [ngClass]="getStatusClassd(equip.status)">
              {{ equip.status }}
            </span>
          </td>
        </tr>
      </ng-template>
      <!-- Add placeholder if table data is empty -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="p-text-center">
            <div class="table-placeholder">
              <i class="pi pi-database"></i>
              <p>No equipment fit data available for selected filters.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <ng-template pTemplate="footer">
    <div style="display: flex; justify-content: flex-end;">
      <button pButton label="Close" icon="pi pi-times" class="p-button-text p-button-secondary"
        (click)="showEquipmentFitDialog = false">
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Approve Plan Dialog -->
<p-dialog header="Approve Maintenance Plan" [(visible)]="showApprovePlanDialog" [style]="{ width: '800px' }"
  styleClass="custom-dialog" [modal]="true" [closable]="true">

  <div class="approval-content p-fluid p-formgrid p-grid p-3 gap-3">
    <p class="p-col-12" style="margin-bottom: 1rem;">Please review the details of the maintenance plan before proceeding
      with approval or rejection:</p>

    <div class="maintenance-plan-summary p-col-12 p-mb-4">
      <p><strong>🆔 Plan ID:</strong> MP-2023-045</p>
      <p><strong>🚢 Ship:</strong> INS Vikrant</p>
      <p><strong>🗓 Proposed Date:</strong> 2025-07-15 to 2025-07-20</p>
      <p><strong>📝 Total Tasks:</strong> 18</p>
      <p><strong>⏱ Estimated Hours:</strong> 120</p>
      <p><strong>🧑‍🔧 Responsible Dept.:</strong> Engineering</p>
    </div>

    <!-- Approver Comments -->
    <div class="p-field p-col-12">
      <label for="approverComments" class="p-text-bold">Reviewer Comments</label>
      <textarea id="approverComments" pInputTextarea rows="4" [(ngModel)]="approverComments"
        placeholder="Add comments regarding the plan, approval, or rejection reasons."></textarea>
    </div>

    <!-- Approval Status (if applicable, read-only for current action) -->
    <div class="p-field p-col-12 p-md-6" *ngIf="false"> <!-- Example of conditional field -->
      <label for="approvalStatus" class="p-text-bold">Current Status</label>
      <input id="approvalStatus" type="text" pInputText value="Pending Review" [readOnly]="true" class="border-2 border-gray-500 rounded-sm bg-white"
        style="width:100%" />
    </div>

    <!-- Approver's Name (auto-filled) -->
    <div class="p-field p-col-12 p-md-6" *ngIf="false"> <!-- Example of auto-filled field -->
      <label for="approverName" class="p-text-bold">Approver</label>
      <input id="approverName" type="text" pInputText value="CAPT. J. Smith" [readOnly]="true" class="border-2 border-gray-500 rounded-sm bg-white"
        style="width:100%" />
    </div>

  </div>

  <ng-template pTemplate="footer">
    <div class="p-d-flex p-jc-end p-ai-center p-gap-2 p-px-3 pb-2">
      <button pButton label="Reject" icon="pi pi-times-circle" class="p-button-danger p-button-outlined"
        (click)="showApprovePlanDialog = false">
      </button>
      <button pButton label="Approve" icon="pi pi-check-circle" class="p-button-success"
        (click)="approveMaintenancePlan()">
      </button>
    </div>
  </ng-template>
</p-dialog>